<head>
    <title>Media stream demo</title>
    <meta charset="utf-8" />
</head>

<body>
    <div class="container">
        <h1>Stream display</h1>
        <video width="1280" height="720"></video>
    </div>

    <script>
        // Older browsers might not implement mediaDevices at all, so we set an empty object first
        if (navigator.mediaDevices === undefined) {
            navigator.mediaDevices = {};
        }

        // Some browsers partially implement mediaDevices. We can't just assign an object
        // with getUserMedia as it would overwrite existing properties.
        // Here, we will just add the getUserMedia property if it's missing.
        if (navigator.mediaDevices.getUserMedia === undefined) {
            navigator.mediaDevices.getUserMedia = function (constraints) {

                // First get ahold of the legacy getUserMedia, if present
                var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

                // Some browsers just don't implement it - return a rejected promise with an error
                // to keep a consistent interface
                if (!getUserMedia) {
                    return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                }

                // Otherwise, wrap the call to the old navigator.getUserMedia with a Promise
                return new Promise(function (resolve, reject) {
                    getUserMedia.call(navigator, constraints, resolve, reject);
                });
            }
        }
        function download(data) {
            var blob = new Blob(data, {
                type: "video/webm"
            });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            document.body.appendChild(a);
            a.style = "display: none";
            a.href = url;
            a.download = "test.webm";
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function record(video) {
            let stream = video.captureStream();
            let recordedChunks = [];

            let options = { mimeType: 'video/webm; codecs=vp9' };
            let mediaRecorder = new MediaRecorder(stream, options);

            mediaRecorder.ondataavailable = function (event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                    download(recordedChunks);
                }
            }

            mediaRecorder.start();

            setTimeout(event => {
                record(video);
                mediaRecorder.stop();
            }, 60000);
        }

        function sendStream(stream) {
            let config = {};
            let conn = new RTCPeerConnection(config);

            conn.addTrack(stream);
        }

        async function getMedia(constraints) {
            return navigator.mediaDevices.getUserMedia(constraints)
        }

        (async function () {
            let constraints = { audio: false, video: true };

            let constraintsWithPreferenced = {
                audio: false,
                video: {
                    width: 1280, // inherently "ideal"
                    height: 720
                }
            };

            let constraintsWithRequirements = {
                audio: false,
                video: {
                    width: { min: 1280 }, // min, max, ideal (non-mandatory)
                    height: { min: 720 }
                }
            };

            let stream = await getMedia(constraints);

            if (stream !== null) {
                let video = document.querySelector('video');

                if ('srcObject' in video) video.srcObject = stream;
                // Avoid using this in new browsers, as it is going away.
                else video.src = window.URL.createObjectURL(stream);

                video.addEventListener('loadedmetadata', function (e) {
                    video.play();
                });

                // record(video);
                sendStream(video.captureStream());

            } else {
                alert('Error: No video stream available.');
            }
        })();
    </script>
    <style>
        .container {
            text-align: center;
            max-width: 1280;
            margin: 0 auto;
        }
    </style>
</body>